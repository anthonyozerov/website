<!--#set var="title" value="Line Printer Automation"-->
<!--#include virtual="/head.html"-->
<link rel="stylesheet" href="/stylesheets/prettified.css">
<!--#include virtual="/header.html"-->

<p>I have an Epson dot-marix printer, which I use for quickly and reliably printing large volumes of text-based information. It is pretty loud and it's annoying to feed the paper out a few centimeters once I'm done sending data. I have written some code that fixes these issues by allowing me to send data to it remotely (<i>i.e.</i> from a room where the printer won't obliterate my ears) and automatically feeding the paper out.</p>
<p>The two programs I've written can be taken advantage of using something like <span class="code">cat file.txt | nc 192.168.0.20 10000</span> on the client-side (to send <span class="code">file.txt</span> to the device connected to the printer) and <span class="code">lpr-server 10000 | lpr-peek > /dev/lp0</span> on the server-side (to listen on port <span class="code">10000</span>, pass the data through <span class="code">lpr-peek</span>, and write it to the printer at <span class="code">/dev/lp0</span></p>
<h2>lpr-peek</h2>
<p><span class="code">lpr-peek</span> is a C program takes in the data I want to print in stdin and outputs it to stdout. But the important thing is that, when no data has been received for some time, it sends the printer a control code to feed the paper out a few centimeters for easy tearing, and when data is received again, it sends the printer a control code to feed the paper back in. It also has some optional lines to switch the printer's font.</p>
<pre class="codeblock" style=""><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;stdio.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;stdlib.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;unistd.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;sys/types.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;sys/wait.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;string.h&gt;</span><span class="pln"><br><br></span><span class="kwd">void</span><span class="pln">&nbsp;feedOut</span><span class="pun">(){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//printf("SIMULATED&nbsp;FEED&nbsp;OUT\n");</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="pun">(</span><span class="str">"\x1BJ\xD8\x1BJ\xD8\x1BJ\x6C"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;fflush</span><span class="pun">(</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br></span><span class="kwd">void</span><span class="pln">&nbsp;feedIn</span><span class="pun">(){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//printf("SIMULATED&nbsp;FEED&nbsp;IN\n");</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="pun">(</span><span class="str">"\x1Bj\xD8\x1Bj\xD8\x1Bj\x6C"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;fflush</span><span class="pun">(</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">int</span><span class="pln">&nbsp;main</span><span class="pun">(){</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//set&nbsp;font&nbsp;to&nbsp;Roman:</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="pun">(</span><span class="str">"\ex1"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="pun">(</span><span class="str">"\ek0"</span><span class="pun">);</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="pun">(</span><span class="str">"\n\n"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;feedIn</span><span class="pun">();</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;linelength</span><span class="pun">=</span><span class="lit">80</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">char</span><span class="pln">&nbsp;buf</span><span class="pun">[</span><span class="pln">linelength</span><span class="pun">+</span><span class="lit">2</span><span class="pun">];</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;eof</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">while</span><span class="pun">(!</span><span class="pln">eof</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">pid_t</span><span class="pln">&nbsp;pid</span><span class="pun">=</span><span class="pln">fork</span><span class="pun">();</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">pid</span><span class="pun">==</span><span class="lit">0</span><span class="pun">){</span><span class="pln">&nbsp;</span><span class="com">//child&nbsp;timer&nbsp;process</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><span class="pun">(</span><span class="lit">5</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;feedOut</span><span class="pun">();</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">else</span><span class="pun">{</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eof</span><span class="pun">=!</span><span class="pln">fgets</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">),</span><span class="pln">stdin</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf</span><span class="pun">[</span><span class="pln">strlen</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">)-</span><span class="lit">1</span><span class="pun">]=</span><span class="str">'\n'</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">waitpid</span><span class="pun">(</span><span class="pln">pid</span><span class="pun">,</span><span class="pln">&nbsp;NULL</span><span class="pun">,</span><span class="pln">&nbsp;WNOHANG</span><span class="pun">)&lt;=</span><span class="lit">0</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kill</span><span class="pun">(</span><span class="pln">pid</span><span class="pun">,</span><span class="pln">&nbsp;SIGKILL</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waitpid</span><span class="pun">(</span><span class="pln">pid</span><span class="pun">,</span><span class="pln">&nbsp;NULL</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">eof</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;feedOut</span><span class="pun">();</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">else</span><span class="pln">&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(!</span><span class="pln">eof</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;feedIn</span><span class="pun">();</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fflush</span><span class="pun">(</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">eof</span><span class="pun">)</span><span class="pln">&nbsp;fputs</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fflush</span><span class="pun">(</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;<br></span><span class="pun">}</span></pre>
<p>Compiled binary: <span class="code"><a href="lpr-peek">lpr-peek</a></span></p>
<p>Source: <span class="code"><a href="lpr-peek.c">lpr-peek.c</a></span></p>
<p>Makefile: <span class="code"><a href="Makefile">Makefile</a></span></p>


<h2>lpr-server</h2>
<p><span class="code">lpr-server</span> is a C program intended to be used on a device connected to a line printer. It just makes connections with clients and outputs the data to stdout.</p>
<pre class="codeblock"><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;stdio.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;stdlib.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;unistd.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;string.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;sys/types.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;sys/socket.h&gt;</span><span class="pln"><br></span><span class="com">#include</span><span class="pln">&nbsp;</span><span class="str">&lt;arpa/inet.h&gt;</span><span class="pln"><br><br></span><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;</span><span class="kwd">die</span><span class="pun">(</span><span class="kwd">const</span><span class="pln">&nbsp;</span><span class="kwd">char</span><span class="pln">&nbsp;</span><span class="pun">*</span><span class="pln">s</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span><span class="pln">&nbsp;perror</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln">&nbsp;</span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span><span class="pln">&nbsp;</span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">int</span><span class="pln">&nbsp;main</span><span class="pun">(</span><span class="kwd">int</span><span class="pln">&nbsp;argc</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">char</span><span class="pln">&nbsp;</span><span class="pun">**</span><span class="pln">argv</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">argc&nbsp;</span><span class="pun">!=</span><span class="pln">&nbsp;</span><span class="lit">2</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf</span><span class="pun">(</span><span class="pln">stderr</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"usage:&nbsp;%s&nbsp;&lt;server-port&gt;\n"</span><span class="pun">,</span><span class="pln">&nbsp;argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">unsigned</span><span class="pln">&nbsp;</span><span class="kwd">short</span><span class="pln">&nbsp;port&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;atoi</span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]);</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//START&nbsp;BOILERPLATE</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;servsock</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">((</span><span class="pln">servsock&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;socket&nbsp;</span><span class="pun">(</span><span class="pln">AF_INET</span><span class="pun">,</span><span class="pln">&nbsp;SOCK_STREAM</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">))</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">die</span><span class="pun">(</span><span class="str">"socket&nbsp;failed"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">struct</span><span class="pln">&nbsp;sockaddr_in&nbsp;servaddr</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;memset</span><span class="pun">(&amp;</span><span class="pln">servaddr</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">servaddr</span><span class="pun">));</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;servaddr</span><span class="pun">.</span><span class="pln">sin_family&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;AF_INET</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;servaddr</span><span class="pun">.</span><span class="pln">sin_addr</span><span class="pun">.</span><span class="pln">s_addr&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;htonl</span><span class="pun">(</span><span class="pln">INADDR_ANY</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;servaddr</span><span class="pun">.</span><span class="pln">sin_port&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;htons</span><span class="pun">(</span><span class="pln">port</span><span class="pun">);</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">bind</span><span class="pun">(</span><span class="pln">servsock</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln">&nbsp;sockaddr&nbsp;</span><span class="pun">*)</span><span class="pln">&nbsp;</span><span class="pun">&amp;</span><span class="pln">servaddr</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">servaddr</span><span class="pun">))</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">die</span><span class="pun">(</span><span class="str">"bind&nbsp;failed"</span><span class="pun">);</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">listen</span><span class="pun">(</span><span class="pln">servsock</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">5</span><span class="pln">&nbsp;</span><span class="com">/*&nbsp;queue&nbsp;size&nbsp;for&nbsp;connection&nbsp;requests&nbsp;*/</span><span class="pln">&nbsp;</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">die</span><span class="pun">(</span><span class="str">"listen&nbsp;failed"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;clntsock</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">socklen_t</span><span class="pln">&nbsp;clntlen</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">struct</span><span class="pln">&nbsp;sockaddr_in&nbsp;clntaddr</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">while</span><span class="pun">(</span><span class="lit">1</span><span class="pun">){</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//fprintf(stderr,&nbsp;"waiting&nbsp;for&nbsp;client&nbsp;...&nbsp;");</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clntlen&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">clntaddr</span><span class="pun">);</span><span class="pln"><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">((</span><span class="pln">clntsock&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;accept</span><span class="pun">(</span><span class="pln">servsock</span><span class="pun">,</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln">&nbsp;sockaddr&nbsp;</span><span class="pun">*)</span><span class="pln">&nbsp;</span><span class="pun">&amp;</span><span class="pln">clntaddr</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="pun">&amp;</span><span class="pln">clntlen</span><span class="pun">))</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">die</span><span class="pun">(</span><span class="str">"accept&nbsp;failed"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//fprintf(stderr,&nbsp;"client&nbsp;ip:&nbsp;%s\n",&nbsp;inet_ntoa(clntaddr.sin_addr));</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//END&nbsp;BOILERPLATE</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">char</span><span class="pln">&nbsp;buf</span><span class="pun">[</span><span class="lit">1000</span><span class="pun">];</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;bytes</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">while</span><span class="pln">&nbsp;</span><span class="pun">((</span><span class="pln">bytes&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;recv</span><span class="pun">(</span><span class="pln">clntsock</span><span class="pun">,</span><span class="pln">&nbsp;buf</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">)-</span><span class="lit">1</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">))</span><span class="pln">&nbsp;</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">/*char&nbsp;*p=buf;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(*p++!='\n');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*p='\0';*/</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf</span><span class="pun">[</span><span class="pln">bytes</span><span class="pun">]=</span><span class="str">'\0'</span><span class="pun">;</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fputs</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fflush</span><span class="pun">(</span><span class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">bytes&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf</span><span class="pun">(</span><span class="pln">stderr</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"ERR:&nbsp;recv&nbsp;failed\n"</span><span class="pun">);</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close</span><span class="pun">(</span><span class="pln">clntsock</span><span class="pun">);</span><span class="pln"><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln"><br><br></span><span class="pun">}</span></pre>
<p>Compiled binary: <span class="code"><a href="lpr-server">lpr-server</a></span></p>
<p>Source: <span class="code"><a href="lpr-server.c">lpr-server.c</a></span></p>
<p>Makefile: <span class="code"><a href="Makefile">Makefile</a></span></p>

<!--#include virtual="/footer.html"-->
